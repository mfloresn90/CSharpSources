<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
    <head><link rel="stylesheet" type="text/css" href="description/Combined.css,0:sprite;/Areas/Epx/Themes/Windows/Content:0&amp;amp;hashKey=15EDE1F25211E852032D2691D5FEB7B8" xmlns="http://www.w3.org/1999/xhtml" />
<link rel="stylesheet" type="text/css" href="description/9d0720cf-bf50-484c-bf6c-77cf57a10f7cCombined.css,0:sprite,1:LinkList;/Areas/Epx/Themes/Windows/Content:0,/Areas/Epx/Themes/Base/Content:1&amp;amp;hashKey=52ADCBE5376E50AE6798D3D038D063E9" xmlns="http://www.w3.org/1999/xhtml" />

        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>USB CDC Control sample</title>
        <link href="description/Galleries.css" type="text/css" rel="Stylesheet" /><link href="description/Layout.css" type="text/css" rel="Stylesheet" /><link href="description/Brand.css" type="text/css" rel="Stylesheet" /><link href="description/f1d4cd5b-ee0e-41ab-9a4f-a8fc36768c28Brand.css" type="text/css" rel="Stylesheet" />
        <link href="description/iframedescription.css" rel="Stylesheet" type="text/css" />
        <script src="description/offline.js" type="text/javascript"></script>
        <style type="text/css">
            #projectInfo {
                overflow: auto;
            }
            #longDesc {
                clear:both;
                margin: 25px 0 10px 0;
            }

            #SampleIndexList{
                margin-left: 15px;
            }
        </style>
    </head>
<body>
    <div id="offlineDescription">
        <h1>USB CDC Control sample</h1>
        <br/>
        <div id="projectInfo">
            <div class="section">
                    <div class="itemBarLong tagsContainer">
                        <label for="Technologies">Technologies</label>
                        <div id="Technologies">
                            Windows Runtime
                        </div>
                    </div>
                    <div class="itemBarLong tagsContainer">
                        <label for="Topics">Topics</label>
                        <div id="Topics">
                            usb, communications device class
                        </div>
                    </div>
                <div class="itemBarLong">
                    <label for="Platforms">Platforms</label>
                    <div id="Platforms">
                        Windows RT
                    </div>
                </div>
                <div class="itemBarLong">
                    <label for="Requirements">Requirements</label>
                    <div id="Requirements">
                        
                    </div>
                </div>
                <div class="itemBar">
                    <label for="LastUpdated">Primary language</label>
                    <div id="LastUpdated">en-US</div>
                </div>
                <div class="itemBar">
                    <label for="LastUpdated">Updated</label>
                    <div id="LastUpdated">11/25/2013</div>
                </div>
                <div class="itemBarLong">
                    <label for="License">License</label>
                    <div id="License">
                        <a href="license.rtf">MS-LPL</a></div>
                </div>
                <div class="itemBar">
                    <div class="viewonlinecont">
                        <a data-link="online" href="http://code.msdn.microsoft.com/windowsapps/USB-CDC-Control-sample-5ba19caa">View this sample online</a>
                    </div>
                </div>
            </div>
        </div>
        
                   
<script type="text/javascript">
    function initializePage() {
        var otherTabClass = 'otherTab';
        var hiddenPreClass = 'hidden';

        var htmlDecode = function(encodedData) {
            var decodedData = "";
            if (encodedData) {
                var div = document.createElement('div');
                div.innerHTML = encodedData;
                decodedData = div.firstChild.nodeValue.replace( /\\r\\n/ig , '\r\n');
            }
            return decodedData;
        };
                
        Galleries.iterateElem(Galleries.findElem(null, 'div', 'scriptcode'), function (index, scriptBlock) {
            var titleElem = Galleries.findElem(scriptBlock, 'div', 'title')[0];
            var labelElems = Galleries.findElem(titleElem, 'span');
            if (labelElems.length == 0) {
                labelElems = titleElem;
            }
            var languageSpans = Galleries.findElem(scriptBlock, 'span', 'hidden');
            var pres = Galleries.findElem(scriptBlock, 'pre');
            if (languageSpans.length > 0 && pres.length > 1) {
                Galleries.iterateElem(labelElems, function(index, elem) {
                    var codePre = pres[index];
                    var labelSpan = elem;
                    var languageSpan = languageSpans[index];
                            
                    elem.code = codePre.innerHTML.replace( /(\r(\n)?)|((\r)?\n)/ig , '\\r\\n');
                            
                    codePre.className = codePre.className.replace(hiddenPreClass, '');
                            
                    languageSpan.parentNode.removeChild(languageSpan);
                });

                pres = Galleries.findElem(scriptBlock, 'pre');
                Galleries.iterateElem(labelElems, function(index, elem) {
                    var codePre = pres[index];
                    var labelSpan = elem;
                    if (index == 0) {
                        scriptBlock.activeTab = 0;
                    }
                    else {
                        labelSpan.className += otherTabClass;
                        codePre.className += hiddenPreClass;
                    }
                    Galleries.attachEventHandler(labelSpan, 'click', function(e) {
                        var activeTab = scriptBlock.activeTab;
                        labelElems[activeTab].className += otherTabClass;
                        pres[activeTab].className += hiddenPreClass;

                        codePre.className = codePre.className.replace(hiddenPreClass, '');
                        labelSpan.className = labelSpan.className.replace(otherTabClass, '');
                        scriptBlock.activeTab = index;
                    });
                });

                var preview = Galleries.findElem(scriptBlock, 'div', 'preview');
                if (preview.length == 0) {
                    preview.push(pres[pres.length - 1]);
                }
                Galleries.iterateElem(preview, function(index, elem) {
                    elem.parentNode.removeChild(elem);
                });

                if (window.clipboardData && clipboardData.setData) {
                    var copyLink = document.createElement('a');
                    copyLink.href = 'javascript:void(0);';
                    copyLink.className = 'copyCode';
                    copyLink.innerHTML = 'Copy code';
                    Galleries.attachEventHandler(copyLink, 'click', function (e) {
                        clipboardData.setData("Text", htmlDecode(labelElems[scriptBlock.activeTab].code));
                        return false;
                    });
                    scriptBlock.insertBefore(copyLink, scriptBlock.childNodes[0]);
                }
            }
        });
    }

    Galleries.onWindowLoad(function(){
        initializePage();
    });

</script>
<div id="longDesc">
    
<div id="mainSection">
<p>This sample shows how to communicate with a USB CDC (Communications Device Class) device and sends and receives data through serial ports, such as a USB serial converter cable. The sample demonstrates the use of the
<a href="http://msdn.microsoft.com/library/windows/apps/dn278466"><b>Windows.Devices.Usb</b></a> namespace.
</p>
<p>To run this sample you need:</p>
<ul>
<li>USB to RS-232 serial adapters which are compatible with USB CDC standard protocol. For scenario 4-loopback, you need two adapters.
</li><li>A serial device that can send data. </li><li>A null-model cable. </li></ul>
<p>The sample demonstrates these key scenarios:</p>
<ul>
<li><a href="http://msdn.microsoft.com/library/windows/apps/dn303343">How to connect to a USB device</a>
</li><li><a href="http://msdn.microsoft.com/library/windows/apps/dn303347">How to send a USB control transfer</a>
</li><li><a href="http://msdn.microsoft.com/library/windows/apps/dn303346">How to send a USB bulk transfer</a>
</li></ul>
<p></p>
<p>
<table>
<tbody>
<tr>
<th>Windows runtime class</th>
<th>Description</th>
</tr>
<tr>
<td>DeviceListEntry</td>
<td>
<p>This class stores <a href="http://msdn.microsoft.com/library/windows/apps/br225393">
<b>DeviceInformation</b></a> objects associated with each device, dynamically detected by the
<a href="http://msdn.microsoft.com/library/windows/apps/br225446"><b>DeviceWatcher</b></a> object. This class is used by the UI to display device-specific information.</p>
</td>
</tr>
<tr>
<td>DeviceList</td>
<td>
<p>The singleton class creates a <a href="http://msdn.microsoft.com/library/windows/apps/br225446">
<b>DeviceWatcher</b></a> object that finds all devices that use Winusb.sys as the device driver. The list of detected devices are shown on the UI list.</p>
<p>Each device in the list is a DeviceListEntry object.</p>
</td>
</tr>
<tr>
<td>CdcAcmInitialize</td>
<td>
<p>This class implements methods that opens the device (gets the <a href="http://msdn.microsoft.com/library/windows/apps/dn263883">
<b>UsbDevice</b></a> object) selected by the user. After that, it instantiates the UsbSerialPort class that represents a virtual serial port.
</p>
<p>When the user clicks the <b>Initialize</b> button, based on the properties selected by the user such as DTERate, ParityType, and so on, it opens the serial port for communication. All subsequent transfers are sent to or received from that port.
</p>
</td>
</tr>
<tr>
<td>CdcAcmRead</td>
<td>
<p>The class implements methods that read from the bulk IN endpoint of the USB CDC device. The user can request a specific number of bytes to read, or can get continuous input of data read from the endpoint.
</p>
<p>Data is read by using the <a href="http://msdn.microsoft.com/library/windows/apps/br208119">
<b>DataReader</b></a> object.</p>
</td>
</tr>
<tr>
<td>CdcAcmWrite</td>
<td>
<p>The class implements methods that write to the bulk OUT endpoint of the USB CDC device. The user can write a text string or contents of a binary file.
</p>
<p>Data is written by using the <a href="http://msdn.microsoft.com/library/windows/apps/br208154">
<b>DataWriter</b></a> object.</p>
</td>
</tr>
<tr>
<td>CdcAcmLoopback</td>
<td>
<p>The class implements methods that opens two devices. The user writes data to an endpoint of one device and reads that data from the other device. When the page loads for this scenario, the previously selected device is removed from DeviceList.</p>
<p>The detected devices are added to both UI lists. When the user initializes devices, the serial port associated with the first device is opened for writing.</p>
<p>The serial port for the second device is opened for reading. Data is read from the first bulk IN pipe as it arrives from the first bulk OUT endpoint of the first device.</p>
<p>Data is read and written by using <a href="http://msdn.microsoft.com/library/windows/apps/br208119">
<b>DataReader</b></a> and <a href="http://msdn.microsoft.com/library/windows/apps/br208154">
<b>DataWriter</b></a> objects.</p>
</td>
</tr>
<tr>
<td>UsbSerialPort</td>
<td>
<p>This class implements a virtual COM port that exposes the underlying <a href="http://msdn.microsoft.com/library/windows/apps/dn263883">
<b>UsbDevice</b></a> object as a serial device. It implements methods to perform these tasks:</p>
<ul>
<li>Statically creates a new instance of the class. By querying the UsbDevice object, it enumerates all USB interfaces to validate that the interface class codes are either CDCControl or CDC data. It also validates that the device has bulk endpoints for data
 transfers. </li><li>Opens the serial port using the specified baud rate, parity bit, data bits, and stop bit.
</li><li>Sends a CDC control request to a specific USB interface on the device. </li><li>Reads a number of bytes from the port's input buffer and writes those bytes into a byte array at the specified offset. The input buffer is mapped to the input stream of the first bulk IN pipe in the current alternate setting of the interface.
</li><li>Writes a specified number of bytes to the serial port. Data is written to the first bulk OUT pipe in the current alternate setting of the interface.
</li><li>Gets a value that enables the Data Terminal Ready (DTR) signal during serial communication.
</li><li>Gets a value that indicates whether the Request to Send (RTS) signal is enabled during serial communication.
</li><li>Gets or sets the number of milliseconds before a time-out occurs when a read operation does not finish.
</li><li>Sends GET_LINE_CODING CDC and SET_LINE_CODING CDC requests that get and set bit rate, stop bits, parity, and number of data bits for the port.
</li></ul>
Most operations are asynchronous (see <a href="http://msdn.microsoft.com/library/windows/apps/br205802">
<b>IAsyncOperation</b></a>) and the result depends on the type of operation. For example for read or write, it indicates the number of bytes read or written.
<p></p>
</td>
</tr>
</tbody>
</table>
</p>
<p><b>App manifest package </b></p>
<p>The sample adds the <a href="http://msdn.microsoft.com/library/windows/apps/br211430">
<b>DeviceCapability</b></a> element in the Package.appxmanifest file. Device information includes the device's vendor/product Ids and device class information.
</p>
<p>To use the sample, add vendor/product id information for your USB to serial adapter to the Package.appxmanifest file. You can obtain that information from the Device Manager properties (see
<b>Hardware Id</b>). </p>
<pre class="syntax"><code> &lt;Capabilities&gt;
    &lt;m2:DeviceCapability Name=&quot;usb&quot;&gt;
      &lt;m2:Device Id=&quot;vidpid:056E 5003&quot;&gt;
        &lt;m2:Function Type=&quot;classId:ff * *&quot; /&gt;
      &lt;/m2:Device&gt;
      &lt;m2:Device Id=&quot;vidpid:056E 5004&quot;&gt;
        &lt;m2:Function Type=&quot;classId:ff * *&quot; /&gt;
      &lt;/m2:Device&gt;
    &lt;/m2:DeviceCapability&gt;
  &lt;/Capabilities&gt;</code></pre>
<h2><a id="related_topics"></a>Related topics</h2>
<dl><dt><a href="http://msdn.microsoft.com/library/windows/apps/dn303355">Writing a Windows store app for a USB device</a>
</dt><dt><a href="http://msdn.microsoft.com/library/windows/apps/dn278466"><b>Windows.Devices.Usb</b></a>
</dt><dt><a href="http://go.microsoft.com/fwlink/p/?LinkID=227694">Windows app samples</a>
</dt></dl>
<h2>Related technologies</h2>
<a href="http://msdn.microsoft.com/library/windows/apps/dn278466"><b>Windows.Devices.Usb</b></a>
<p>Provides Windows Runtime classes and enumerations that a Windows store app can use to communicate with an external USB device that uses WinUSB (Winusb.sys) as the device driver.
</p>
, <a href="http://msdn.microsoft.com/library/windows/apps/br225446"><b>DeviceWatcher</b></a>
<p>Enumerates devices dynamically, so that the app receives notifications if devices are added, removed, or changed after the initial enumeration is complete.
</p>
, <a href="http://msdn.microsoft.com/library/windows/apps/br208119"><b>DataReader</b></a>
<p>Reads data from an input stream. Used for reading data from a USB pipe.</p>
, <a href="http://msdn.microsoft.com/library/windows/apps/br208154"><b>DataWriter</b></a>
<p>Writes data to an output stream. Used for writing data to a USB pipe.</p>
<h2>Operating system requirements</h2>
<table>
<tbody>
<tr>
<th>Client</th>
<td><dt>Windows&nbsp;8.1 </dt></td>
</tr>
<tr>
<th>Server</th>
<td><dt>Windows Server&nbsp;2012&nbsp;R2 </dt></td>
</tr>
</tbody>
</table>
<h2>Build the sample</h2>
<h2><a id="Driver_requirements"></a><a id="driver_requirements"></a><a id="DRIVER_REQUIREMENTS"></a>Driver requirements</h2>
<p>The sample app communicates with the device through the Microsoft-provided kernel-mode driver, Winusb.sys. You must install it as the device driver.
</p>
<p>Hardware manufacturers can specify Winusb.sys as the device driver in either of these two ways:</p>
<ul>
<li>By providing a custom INF that references the Microsoft-provided Winusb.inf file. For more information, see
<a href="http://msdn.microsoft.com/library/windows/apps/ff540283">WinUSB (Winusb.sys) Installation</a>.
</li><li>By setting Microsoft operating system (OS) feature descriptors that report the compatible ID as &quot;WINUSB&quot;. In this case, Windows matches the compatible ID with the driver and automatically loads Winusb.sys as the device driver. For more information, see
<a href="http://msdn.microsoft.com/library/windows/apps/hh450799">WinUSB Device</a>.
</li></ul>
When you connect your device, you might notice that Windows loads Winusb.sys automatically. Otherwise follow these instructions to load the driver:
<ol>
<li>Open Device Manager and locate the device. </li><li>Right-click the device and select <b>Update driver software...</b> from the context menu.
</li><li>In the wizard, select <b>Browse my computer for driver software</b>. </li><li>Select <b>Let me pick from a list of device drivers on my computer</b>. </li><li>From the list of device classes, select <b>Universal Serial Bus devices</b>. </li><li>The wizard displays <b>WinUsb Device</b>. Select it to load the driver. </li></ol>
<p></p>
<h2><a id="Setting_the_DeviceInterfaceGUID_for_the_device"></a><a id="setting_the_deviceinterfaceguid_for_the_device"></a><a id="SETTING_THE_DEVICEINTERFACEGUID_FOR_THE_DEVICE"></a>Setting the DeviceInterfaceGUID for the device</h2>
<p>If the device appears in Device Manager but the sample cannot detect it, make sure that the DeviceInterfaceGUID is set for this device in one of these ways:
</p>
<ul>
<li>If you can modify the device firmware, add the WinUSB compatible ID and DeviceInterfaceGUID in the MS OS descriptor. For more information, see Registering a device interface GUID in
<a href="http://msdn.microsoft.com/library/windows/apps/hh450799">WinUSB Device</a>. More information is included in this blog post:
<a href="http://blogs.msdn.com/b/usbcoreblog/archive/2012/09/26/how-to-install-winusb-sys-without-a-custom-inf.aspx">
How to install WinUSB.sys without a custom INF</a>. </li><li>Add the GUID in a custom INF that specifies Winusb.sys as the function driver for the device. Here is an example:
<p><code>[Dev_AddReg] </code></p>
<p><code>HKR,,DeviceInterfaceGUIDs,0x10000,&quot;{875d47fc-d331-4663-b339-624001a2dc5e}&quot;
</code></p>
</li><li>Add the GUID in the registry.
<ol>
<li>Load the Wiusb.sys in Device Manager as per the instructions given in the previous section.
</li><li>Generate a device interface GUID by using a tool such as guidgen.exe. </li><li>Find the registry key for your USB to Serial Controller device under this key. In this example, VID and PID of the device is VID_056E&amp;PID_5004:
<p><b>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Enum\USB\VID_0564&amp;PID_5004</b></p>
</li><li>Under the <b>Device Parameters</b> key, add a String registry entry named <b>
DeviceInterfaceGUID</b> or a Multi-String entry named <b>DeviceInterfaceGUIDs</b>. Set the value to the GUID you generated in step 2.
</li><li>Disconnect the device from the system and reconnect it to the same physical port. Apply steps 1 through 4 for each USB to Serial Controller device. Each device has a different device instance. You must add the
<b>DeviceInterfaceGUID</b> entry for each device instance.
<p class="note"><b>Note</b>&nbsp;&nbsp;If you change the physical port then you must repeat steps 1 through 4.</p>
</li></ol>
</li></ul>
<p></p>
<h2><a id="Building_the_Sample"></a><a id="building_the_sample"></a><a id="BUILDING_THE_SAMPLE"></a>Building the Sample</h2>
<p>To build this sample, open the solution (.sln) file titled UsbCdc Control.sln from Microsoft Visual Studio&nbsp;2013. Press F7 or go to
<b>Build</b>-&gt;<b>Build Solution</b> from the top menu after the sample has loaded.</p>
<h2>Run the sample</h2>
<ol>
<li>To run this sample after building it, press F5 (run with debugging enabled) or Ctrl-F5 (run without debugging enabled), or select the corresponding options from the
<b>Debug</b> menu. To deploy the app, select <b>Build</b> &gt; <b>Deploy UsbCdcControl</b>.
</li><li>From the list of detected devices, choose your device and click the <b>Select</b> button.
<p class="note"><b>Note</b>&nbsp;&nbsp;The first time you run the sample, you will be prompted whether you allow the app to use the USB device. Choose
<b>Allow</b> to proceed.</p>
<p>If you do not see your device, most likely Winusb.sys was not loaded as the device driver.
</p>
<p>If you get an exception, make sure that your app manifest file contains vendor/product Ids of your USB to serial adaptor(s).</p>
</li><li>Click the <b>Initialize</b> button. The <b>Output</b> string shows the device as Initialized.
</li><li>Choose one of the scenarios in the <b>Select scenario</b> input box: either <b>
2) Read Data</b> or <b>3) Write Data</b>, and so on. </li><li>To change the serial port parameters, change the values in <b>DTERate</b>, <b>
CharFormat</b>, lists and click <b>Initialize</b>.
<p><img src="description/image.png" alt="" align="middle">
</p>
</li><li>To read data received in Bulk IN endpoint (BulkIn[0]), select <b>2) Read Data</b>.
<p class="note"><b>Note</b>&nbsp;&nbsp;</p>
<p class="note">This scenario only reads when there is data available to read.</p>
<p></p>
<p>This image shows continuous reading and displays data in binary format. In this case, you do not need to specify the number of bytes to read. When you want to stop reading data, click
<b>Stop Continuous Read</b>.</p>
<p>Alternatively, you can specify the number of bytes to read each time you click
<b>Read</b>. You can also specify a timeout value. When that value is expires, the read operation completes. The default value is -1 that indicates infinite timeout.</p>
<p>It blocks until completes reading the specified number of bytes are read or until the timeout value is reached.</p>
<p><img src="description/b4b51331-ffde-4428-9fd7-6e8282372bc6image.png" alt="" align="middle">
</p>
</li><li>To write to the bulk OUT pipe, select <b>3) Write Data</b>.
<p>There are two ways to write data. The simplest way is to send a text string (specified in the input box) by clicking
<b>WriteText</b> as shown in this image. Because the <b>Send NullTerminateChar</b> box is checked, it adds an extra byte to the string. After the write operation is complete, the
<b>Output</b> box shows the text and number of bytes written.</p>
<p><img src="description/9eb75454-5525-4d7b-85a5-8ea710731cf3image.png" alt="" align="middle">
</p>
<p>Alternatively, you can send contents of a binary file. To do so, click <b>Load Binary Data 1</b> or
<b>Load Binary Data 2</b>and then choose a .bin file from the file picker. Then click
<b>Write Binary Data 1</b> or <b>Write Binary Data 2</b>to start the write operation.</p>
<p>You can also send RS-232C break signal during a specified milliseconds time length by clicking the
<b>Send Break</b>.</p>
</li><li>To test loop back, you need two USB to RS-232 adapters which are connected with a null-modem cable. Select devices and click
<b>Initialize both devices</b>.
<p>Write text in the input box and click <b>Test Loopback</b>. The string is displayed in the Output box.</p>
<p><img src="description/5aa56744-f57c-491e-a61d-5b102bc568e5image.png" alt="" align="middle"> If To cancel the loopback test in progress, click
<b>Stop Loopback</b>.</p>
</li></ol>
</div>

</div>


    </div>
</body>
</html>
